"use strict";(self.webpackChunkwebsite_docusaurus=self.webpackChunkwebsite_docusaurus||[]).push([[4503],{7295:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"tutorials/external-webgl-context","title":"External WebGL Contexts with MapLibre","description":"This guide shows how to connect luma.gl to a WebGL context that is created and owned by MapLibre GL JS. It uses the webgl2Adapter.attach API to wrap the map\'s context in a WebGLDevice and keep a WebGLCanvasContext synchronized with MapLibre\'s canvas.","source":"@site/../docs/tutorials/external-webgl-context.mdx","sourceDirName":"tutorials","slug":"/tutorials/external-webgl-context","permalink":"/docs/tutorials/external-webgl-context","draft":false,"unlisted":false,"editUrl":"https://github.com/visgl/luma.gl/tree/master/docs/../docs/tutorials/external-webgl-context.mdx","tags":[],"version":"current","frontMatter":{},"sidebar":"defaultSidebar","previous":{"title":"Transform Feedback","permalink":"/docs/tutorials/transform-feedback"},"next":{"title":"What\'s Next?","permalink":"/docs/tutorials/whats-next"}}');var r=n(4848),s=n(8453);const i={},o="External WebGL Contexts with MapLibre",l={},c=[{value:"Install dependencies",id:"install-dependencies",level:2},{value:"Attach luma.gl to MapLibre",id:"attach-lumagl-to-maplibre",level:2},{value:"Handle map resizes",id:"handle-map-resizes",level:2},{value:"See it in action",id:"see-it-in-action",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.header,{children:(0,r.jsx)(t.h1,{id:"external-webgl-contexts-with-maplibre",children:"External WebGL Contexts with MapLibre"})}),"\n",(0,r.jsxs)(t.p,{children:["This guide shows how to connect luma.gl to a WebGL context that is created and owned by ",(0,r.jsx)(t.a,{href:"https://maplibre.org/projects/maplibre-gl-js/",children:"MapLibre GL JS"}),". It uses the ",(0,r.jsx)(t.code,{children:"webgl2Adapter.attach"})," API to wrap the map's context in a ",(0,r.jsx)(t.code,{children:"WebGLDevice"})," and keep a ",(0,r.jsx)(t.code,{children:"WebGLCanvasContext"})," synchronized with MapLibre's canvas."]}),"\n",(0,r.jsx)(t.h2,{id:"install-dependencies",children:"Install dependencies"}),"\n",(0,r.jsx)(t.p,{children:"Add MapLibre GL JS alongside luma.gl:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-bash",children:"npm install @luma.gl/webgl @luma.gl/engine maplibre-gl\n"})}),"\n",(0,r.jsxs)(t.p,{children:["This example uses ",(0,r.jsx)(t.a,{href:"https://github.com/CartoDB/basemap-styles",children:"CARTO basemaps"})," so you do not need an API token, but you can still supply a Mapbox token if you point MapLibre at a Mapbox-hosted style elsewhere in your application."]}),"\n",(0,r.jsx)(t.h2,{id:"attach-lumagl-to-maplibre",children:"Attach luma.gl to MapLibre"}),"\n",(0,r.jsx)(t.p,{children:"Create the map first so MapLibre owns the WebGL canvas, then attach the device to that context:"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:"import maplibregl from 'maplibre-gl'\nimport {Matrix4} from '@math.gl/core'\nimport {webgl2Adapter} from '@luma.gl/webgl'\nimport {Model} from '@luma.gl/engine'\n\nconst map = new maplibregl.Map({\n  container: 'map',\n  style: 'https://basemaps.cartocdn.com/gl/positron-gl-style/style.json',\n  antialias: true,\n  pitch: 60,\n  zoom: 12\n})\n\nmap.on('load', async () => {\n  const webglContext = map.getCanvas().getContext('webgl2') as WebGL2RenderingContext\n  const device = await webgl2Adapter.attach(webglContext, {createCanvasContext: {autoResize: false}})\n\n  // Keep the WebGLCanvasContext aligned with MapLibre's drawing buffer\n  device.canvasContext.resize({width: webglContext.drawingBufferWidth, height: webglContext.drawingBufferHeight})\n\n  const modelMatrix = new Matrix4()\n  const viewProjection = new Matrix4()\n\n  const overlay = new Model(device, {\n    id: 'maplibre-overlay',\n    vs: `...`,\n    fs: `...`,\n    shaderLayout: {\n      attributes: [\n        {name: 'positions', location: 0, format: 'float32x3'}\n      ],\n      bindings: [{name: 'app', type: 'uniform', location: 0}]\n    },\n    attributes: {\n      positions: new Float32Array([...])\n    },\n    vertexCount: 6,\n    bindings: {\n      app: /* uniform buffer */\n    }\n  })\n\n  map.addLayer({\n    id: 'luma-gl-overlay',\n    type: 'custom',\n    renderingMode: '3d',\n    render: (_, matrix) => {\n      viewProjection.fromArray(matrix as number[])\n      // Update uniforms and draw without clearing the map's buffers\n      const renderPass = device.beginRenderPass({clearColor: false, clearDepth: false})\n      overlay.draw(renderPass)\n      renderPass.end()\n      map.triggerRepaint()\n    }\n  })\n})\n"})}),"\n",(0,r.jsx)(t.h2,{id:"handle-map-resizes",children:"Handle map resizes"}),"\n",(0,r.jsxs)(t.p,{children:["Because the context comes from MapLibre, luma.gl cannot resize it automatically. Listen for MapLibre ",(0,r.jsx)(t.code,{children:"resize"})," events and keep the ",(0,r.jsx)(t.code,{children:"WebGLCanvasContext"})," in sync:"]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-typescript",children:"map.on('resize', () => {\n  const webglContext = map.getCanvas().getContext('webgl2') as WebGL2RenderingContext\n  device.canvasContext.resize({\n    width: webglContext.drawingBufferWidth,\n    height: webglContext.drawingBufferHeight\n  })\n})\n"})}),"\n",(0,r.jsx)(t.h2,{id:"see-it-in-action",children:"See it in action"}),"\n",(0,r.jsxs)(t.p,{children:["The revived ",(0,r.jsx)(t.a,{href:"/examples/api/external-webgl-context",children:"External WebGL Context example"})," renders a luma.gl overlay driven by MapLibre's WebGL render loop and uses the ",(0,r.jsx)(t.code,{children:"webgl2Adapter.attach"})," API to keep both frameworks in sync."]})]})}function p(e={}){const{wrapper:t}={...(0,s.R)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453:(e,t,n)=>{n.d(t,{R:()=>i,x:()=>o});var a=n(6540);const r={},s=a.createContext(r);function i(e){const t=a.useContext(s);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function o(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),a.createElement(s.Provider,{value:t},e.children)}}}]);