# ShaderModule

In luma.gl, reusable shader modules are defined by objects that conform to the `ShaderModule` type.
For more information see [Shader Module System Guide](/docs/api-guide/shaders/shader-modules).

`ShaderModule`s are used by the luma.gl [shader assembler](./shader-assembler). The shader assembler imports chunks of reusable shader code from the module into your shader program source code.

## Usage

To define a new shader module, you create a descriptor object that brings together all the necessary pieces:

```typescript
export const MY_SHADER_MODULE = {
  name: 'my-shader-module',
  vs: '...',
  fs: '...',
  inject: {},
  dependencies: [],
  deprecations: [],
  getUniforms
};
```

## Fields


#### `name`

- `name` (string) - The name of the shader module.

#### `vs`

- `vs?` - (string | null)

#### `fs`

- `fs` - (string | null)

#### `uniforms` (_Object_) 

#### `inject` (_Object_) - injections the module will make into shader hooks, see below

#### `dependencies` (_Array_) - a list of other shader modules that this module is dependent on

#### `deprecations` (_Array_) - a list of deprecated APIs.

If `deprecations` is supplied, `assembleShaders` will scan shader source code for the deprecated constructs and issue a console warning if found. Each API is described in the following format:

- `type`: `uniform <type>` or `function`
- `old`: name of the deprecated uniform/function
- `new`: name of the new uniform/function
- `deprecated`: whether the old API is still supported.


### Defining Uniforms

If the uniforms of this module can be directly pulled from user settings, they may declaratively defined by a `uniforms` object:

```typescript
{
  name: 'my-shader-module',
  uniforms: {
    strength: {type: 'number', value: 1, min: 0, max: 1},
    center: [0.5, 0.5]
  }
}
```

At runtime, this map will be used to generate the uniforms needed by the shaders. If either `strength` or `center` is present in the user's module settings, then the user's value will be used; otherwise, the default value in the original definition will be used.

Each uniform definition may contain the following fields:

- `type` (string `number`, `boolean`, `array` or `object`
- `value` - the default value of this uniform

With `type: 'number'`, the following additional fields may be added for validation:

- `min` (_Number_)
- `max` (_Number_)

Note: `uniforms` is ignored if `getUniforms` is provided.

## Defining Injections

A map of hook function signatures to either the injection code string, or an object containing the injection code and an `order` option indicating ordering within the hook function. See [assembleShaders]( /docs/api-reference/shadertools/shader-assembler) documentation for more information on shader hooks.

For example:

```typescript
{
  picking: {
    'vs:VERTEX_HOOK_FUNCTION': 'picking_setPickingColor(color.rgb);',
    'fs:FRAGMENT_HOOK_FUNCTION': {
      injection: 'color = picking_filterColor(color);',
      order: Number.POSITIVE_INFINITY
    },
    'fs:#main-end': 'gl_FragColor = picking_filterColor(gl_FragColor);'
  }
}
```

## Functions

#### `getShaderModuleUniforms()`

```ts
getShaderModuleUniforms(module: ShaderModule)
```
- 
- JavaScript function that maps JavaScript parameter keys to uniforms used by this module

Each shader module provides a method to get a map of uniforms for the shader. This function will be called with two arguments:

- `opts` - the module settings to update. This argument may not be provided when `getUniforms` is called to generate a set of default uniform values.
- `context` - the uniforms generated by this module's dependencies.

The function should return a JavaScript object with keys representing uniform names and values representing uniform values.

The function should expect the shape of the dependency uniforms to vary based on what's passed in `opts`. This behavior is intended because we only want to recalculate a uniform if the uniforms that it depends on are changed. An example is the `project` and `project64` modules in deck.device. When `opts.viewport` is provided, `project64` will receive the updated projection matrix generated by the `project` module. If `opts.viewport` is empty, then the `project` module generates nothing and so should `project64`

#### `getShaderModuleDependencies()`

```ts
getShaderModuleDependencies(module: ShaderModule): ShaderModule[]
```

## TODO

:::caution
This page is not complete:
- Describe props to uniforms mapping system
- Better documentation of getShaderModuleUniforms
- Describe all functions working on shader modules
- Better reference information for injections
:::
